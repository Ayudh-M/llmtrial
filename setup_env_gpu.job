#!/bin/bash
#SBATCH -J setup_env_gpu
#SBATCH -A tesr108469
#SBATCH -p gpu_a100
#SBATCH --gpus=1
#SBATCH --time=00:10:00
#SBATCH --cpus-per-task=8
#SBATCH --mem=30G
#SBATCH -o logs/%x-%j.out

set -euo pipefail
cd "$SLURM_SUBMIT_DIR"

# Create/activate venv (idempotent)
module purge
module load 2025
module spider Python
module load Python/3.11.6-GCCcore-13.3.0

python3 -m venv ~/.venvs/consensus
source ~/.venvs/consensus/bin/activate
python -m pip install -U pip wheel

# Project deps (ok if requirements.txt is empty)
pip install -r requirements.txt || true
pip install "transformers>=4.41" "accelerate>=0.30" "jsonschema>=4.21" pyyaml rich

# GPU Torch (CUDA 12.1 runtime)
pip install --index-url https://download.pytorch.org/whl/cu121 torch torchvision --upgrade
echo "Env ready at ~/.venvs/consensus"
